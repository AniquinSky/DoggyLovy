{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}{% endblock %}</h1>
{% endblock %}

{% block content %}
<div class="container">
  <h1 class="text-center">Chat en línea con {{ other_user_id }}</h1>

  <div id="chat-history" class="chat-history">
      {% for message in chat_history %}
          <div class="message {% if message[0] == g.user_id %}message-user-is-sender{% else %}message-user-is-addressee{% endif %}">
              <span class="message-text">{{ message[2] }}</span>
          </div>
      {% endfor %}
  </div>

  <div class="input-group mb-3">
      <textarea id="message" class="form-control" placeholder="Escriba su mensaje aquí..." maxlength="255"></textarea>
      <div class="input-group-append">
          <button id="send-message-button" class="btn btn-primary" onclick="sendMessage()">Enviar</button>
      </div>
  </div>
</div>

<style>
  .message {
      background-color: #e0e0e0;
      padding: 8px;
      margin-bottom: 5px;
      border-radius: 5px;
  }

  .message-user-is-sender {
      background-color: #d3ffd3;
  }
</style>

    <script>
      const room = '{{ chat_room_id }}'
      const socket = io('http://127.0.0.1:5000/socket');
      const chatHistory = document.getElementById('chat-history')
      document.getElementById('message').value = ''

      socket.on('connect', () => {
        console.log('Connected to server');
        socket.emit('joinChatRoom', { creator: '{{ g.user_id }}', guest: '{{ other_user_id }}', room: room })
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from server');
      });

      socket.on('response', (data) => {
        console.log('Received response:', data);
      });

      socket.on('chat', (data) => {
        const paragraph = document.createElement('p')
        const span = document.createElement('SPAN');
        const node = document.createTextNode(data.message)
        span.setAttribute("class", "message-text")
        span.appendChild(node)
        paragraph.appendChild(span)
        if (data.sender == '{{ g.user_id }}') {
          paragraph.setAttribute("class", "chat-message message-user-is-sender")
        }
        else {
          paragraph.setAttribute("class", "chat-message message-user-is-addresse")
        }
        chatHistory.appendChild(paragraph)
      });

      function sendMessage() {
        let messageValue = document.getElementById('message').value
        data = { sender: '{{ g.user_id }}', addresse: '{{ other_user_id }}', message: messageValue, room: room }
        socket.emit('chat', data);
        document.getElementById('message').value = ''
      }
    </script>
</body>
{% endblock %}
